{% block price_list_products_picker_row -%}
    <div class="wrap-divider">
        <div class="form-group">
            <div class="form-group__title">
                <div class="form-group__title">{{ 'Products'|trans }}</div>
            </div>
            {{- form_widget(form) -}}
        </div>
    </div>
{%- endblock %}

{% block price_list_products_picker_widget %}
    {% import _self as self %}
    {% set attr = attr|merge({'class': (attr.class|default('') ~ ' js-products-with-price-picker')|trim}) %}
    <div
            {{ block('widget_attributes') }}
            data-products-picker-prototype="{{ self.productsWidgetItem(null, form.vars.prototype, domainId)|e}}"
            data-products-picker-url="{{ url('admin_productpicker_pickmultiple', {jsInstanceId: '__js_instance_id__', allowMainVariants: 0, allowVariants: 1, withPrice: 1}) }}"
    >
        <table class="table-form">
            <thead class="js-products-with-price-picker-header">
            <tr class="table-form__row">
                <td class="table-form__cell">{{ 'Catalog number'|trans }}</td>
                <td class="table-form__cell">{{ 'EAN'|trans }}</td>
                <td class="table-form__cell">{{ 'Name'|trans }}</td>
                <td class="table-form__cell">{{ 'Special price' |trans }} {{ priceVatLabel() }}</td>
                <td class="table-form__cell">{{ 'Basic price'|trans }} {{ priceVatLabel() }}</td>
                <td class="table-form__cell">{{ 'Discount against basic price'|trans }} {{ priceVatLabel() }}</td>
                <td class="table-form__cell">% {{ 'discount'|trans }}</td>
                <td class="table-form__cell table-form__cell--actions"></td>
            </tr>
            </thead>
            <tbody class="js-products-with-price-picker-items">
            {% for key, productForm in form %}
                {{ self.productsWidgetItem(form.vars.productsWithPrice[key], productForm, domainId) }}
            {% endfor %}
            </tbody>
        </table>
        <div class="form-line form-line--no-top-border">
            <div class="form-line__line form-line__line--no-space">
                <a href="#" class="btn btn--plus js-products-with-price-picker-button-add">
                    <i class="btn__icon">+</i>
                    {{ 'Add product'|trans }}
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% macro productsWidgetItem(productWithPrice, form, domainId) %}
    {% set product = null %}
    {% set discount = null %}
    {% set hasDiscount = null %}
    {% set currency = currencyCode(domainId) %}

    {% if productWithPrice is not null %}
        {% set product = productWithPrice.product %}
        {% set discount = productWithPrice.discount %}
        {% set hasDiscount = productWithPrice.hasDiscount %}
    {% endif %}

    <tr class="js-products-with-price-picker-item table-form__row">
        <td class="table-form__cell">
            <span class="js-products-with-price-picker-item-product-catnum">
                {% if product is not null %}
                    {{ product.catnum }}
                {% endif %}
            </span>
        </td>
        <td class="table-form__cell">
            <span class="js-products-with-price-picker-item-product-ean">
                {% if product is not null %}
                    {{ product.ean }}
                {% endif %}
            </span>
        </td>
        <td class="table-form__cell">
            <span class="js-products-with-price-picker-item-product-name">
                {% if product is not null %}
                    <a
                        href="{{ url('admin_product_edit', {id: product.id}) }}"
                        target="_blank"
                        class="btn-link-style btn-link-style--iconic-l"
                    >
                        <span>
                            {{ product.getName(getDomain().getDomainConfigById(domainId).getLocale()) }}
                        </span>&nbsp;
                        <i class="svg svg-forward-page"></i>
                    </a>
                {% endif %}
            </span>
        </td>
        <td class="table-form__cell">
            {{ form_errors(form.priceAmount, { errors_attr: { class: 'table-limits__cell__error' } } ) }}
            {{ form_widget(form.priceAmount, {
                symbolAfterInput: currencySymbolByDomainId(domainId),
                attr: { class: 'js-products-with-price-picker-item-price-input js-products-with-price-picker-item-input-reorder input--half-width', 'data-name': 'priceAmount' }
            }) }}
        </td>
        <td class="table-form__cell">
            {% if product is not null %}
                <span class="js-products-with-price-picker-item-product-price" data-price="{{ productWithPrice.basicPrice|moneyFormat }}" data-currency="{{ currency }}" data-locale="{{ app.request.locale }}">
                    {{ productWithPrice.basicPrice|priceWithCurrencyByDomainId(domainId) }}
                </span>
            {% else %}
                <span class="js-products-with-price-picker-item-product-price" data-price="0" data-currency="{{ currency }}" data-locale="{{ app.request.locale }}">
                </span>
            {% endif %}
        </td>
        <td class="table-form__cell">
            {% if product is not null %}
                {{ _self.productPrice(discount, hasDiscount, domainId) }}
            {% else %}
                <span class="js-products-with-price-picker-item-product-price-discount"></span>
            {% endif %}
        </td>
        <td class="table-form__cell">
            {% if product is not null %}
                {{ _self.productDiscount(productWithPrice, discount, hasDiscount) }}
            {% else %}
                <span class="js-products-with-price-picker-item-product-price-discount-percentage"></span>
            {% endif %}
        </td>
        <td class="table-form__cell table-form__cell--actions">
            <span class="cursor-pointer js-products-with-price-picker-item-button-delete">
                <span class="svg svg-delete-thin in-icon"></span>
                {{ form_widget(form.product, {attr: {class: 'js-products-with-price-picker-item-input js-products-with-price-picker-item-input-reorder', 'data-name': 'product'}}) }}
                {{ form_widget(form.basicPrice, {attr: {class: 'js-products-with-price-picker-item-base-price-input js-products-with-price-picker-item-input-reorder', 'data-name': 'basicPrice'}}) }}
            </span>
        </td>
    </tr>
{% endmacro %}

{% macro productPrice(discount, hasDiscount, domainId) %}
    {{ _self.showContent(
        discount|priceWithCurrencyByDomainId(domainId),
        hasDiscount,
        'js-products-with-price-picker-item-product-price-discount'
    ) }}
{% endmacro %}

{% macro productDiscount(productWithPrice, discount, hasDiscount) %}
    {{ _self.showContent(
        (discount.amount / (productWithPrice.basicPrice.amount == 0 ? 1 : productWithPrice.basicPrice.amount) * 100)|round(0, 'floor') ~ '%',
        hasDiscount,
        'js-products-with-price-picker-item-product-price-discount-percentage'
    ) }}
{% endmacro %}

{% macro showContent(content, hasDiscount, class) %}
    <span style="color: {{ hasDiscount ? 'green' : 'red' }}" class="{{ class }}">
       {{ content }}
    </span>
{% endmacro %}
